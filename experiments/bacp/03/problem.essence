language Essence 1.3
$ prob030.essence: Balanced Academic Curriculum Problem
$ Problem details available at http://www.csplib.org/Problems/prob030/
$ 07 September 2007

given n_courses, n_periods,load_per_period_lb, load_per_period_ub,
      courses_per_period_lb, courses_per_period_ub : int(1..)

letting Course be domain int(1..n_courses),
        Period be domain int(1..n_periods)

given prerequisite : relation (maxSize n_courses) of (Course * Course),
      course_load : function (total) Course --> int(1..)

where load_per_period_lb < load_per_period_ub
where courses_per_period_lb < courses_per_period_ub

$ A course load can never be greater than the load_per_period_ub:
where forAll course: Course . (course_load(course) <= load_per_period_ub)

$ The sum of all course_loads must equal at least: n_periods * load_per_period_lb
where forAll course: Course . (sum c : Course . course_load(c)) >= n_periods * load_per_period_lb
$ The sum of all course_loads can not be greater than the max possible load
where forAll course: Course . (sum c : Course . course_load(c)) <= n_periods * load_per_period_ub

$ You must have at least a number of courses to meet the lower bound on the number of courses per period:
where n_courses >= n_periods * courses_per_period_lb
where n_courses <= n_periods * courses_per_period_ub

$ prerequisite must not be empty
where |prerequisite|>0

$ a course cannot be prerequisite for itself
where forAll (a,b) in toSet(prerequisite) . a!=b

$ most partial orders have 3 layers, enforce to avoid overly dense instances
given level : function (total) Course --> int(1..3)
where forAll (a,b) in toSet(prerequisite) . level(a) < level(b)

find curr : function (total) Course --> Period

such that
    forAll c1,c2 : Course . prerequisite(c1,c2) -> curr(c1) < curr(c2),
    forAll p : Period . (sum c in preImage(curr,p) . course_load(c)) <= load_per_period_ub /\
                        (sum c in preImage(curr,p) . course_load(c)) >= load_per_period_lb,
    forAll p : Period . |preImage(curr,p)| <= courses_per_period_ub /\ |preImage(curr,p)| >= courses_per_period_lb
